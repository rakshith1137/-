<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const frame = new Image();
frame.src = "frame.jpeg";

let userImg = null;

// EXACT white box area
const PHOTO = { x:620, y:270, w:360, h:360, r:30 };

function roundRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

frame.onload = ()=>{
  canvas.width = frame.width;
  canvas.height = frame.height;
  draw();
};

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 1️⃣ DRAW FRAME FIRST
  ctx.drawImage(frame,0,0);

  // 2️⃣ DRAW USER IMAGE ON TOP (CLIPPED)
  if(userImg){
    const scale = Math.max(
      PHOTO.w / userImg.width,
      PHOTO.h / userImg.height
    );

    const dw = userImg.width * scale;
    const dh = userImg.height * scale;
    const dx = PHOTO.x + (PHOTO.w - dw)/2;
    const dy = PHOTO.y + (PHOTO.h - dh)/2;

    ctx.save();
    roundRect(PHOTO.x,PHOTO.y,PHOTO.w,PHOTO.h,PHOTO.r);
    ctx.clip();
    ctx.drawImage(userImg, dx, dy, dw, dh);
    ctx.restore();
  }
}

upload.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    const img = new Image();
    img.onload = ()=>{
      userImg = img;
      draw();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
};

function download(){
  const a = document.createElement("a");
  a.download = "shivaratri-dp.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
}
</script>
